var BEZIER=BEZIER||{};BEZIER.widgets=BEZIER.widgets||{};BEZIER.widgets.visualizer_3d=function(c,d,n,k){if(!c){throw BEZIER.errors.illegal_argument_error("curve_storage cannot be null")}var i=100;k=k||BEZIER.widgets.stage_basic;var p=BEZIER.widgets.render_solid_tube;var o={};var e={points_visible:true,polygon_visible:true,curve_visible:true,size:0.25};var h=k(d||500,n||500);var f=h.make_scene();var a=false;function b(){h.renderer.render(f,h.camera);a=true}function l(u,r,v,s){var q=o[u];if(!q){return}var t=q.options;var w=q.meshes[s];if(r!==null){t[v]=Boolean(r);w.traverse(function(x){x.visible=r})}}var g={get_options:function(r){if(r==="default"){return jQuery.extend({},e)}var q=o[r];if(!q){return}return jQuery.extend({},q.options)},get_num_points:function(){return i},set_num_points:function(q){i=q},set_curve_factory:function(q){p=q||p},update:function(){a=false;h.camera_controls.update();if(!a){b()}},get_view:function(){var r=h.camera_controls.target;var q=h.camera_controls.object.position;return{target:BEZIER.core.dim3(r.x,r.y,r.z),position:BEZIER.core.dim3(q.x,q.y,q.z)}},set_view:function(r,q){if(!r){throw BEZIER.errors.illegal_argument_error("Target cannot be null.")}h.camera_controls.target=new THREE.Vector3(r.x,r.y,r.z);if(q){h.camera_controls.object.position=new THREE.Vector3(q.x,q.y,q.z)}this.update()},set_curve_size:function(t,q){var r=o[t];if(!r){return}var s=r.options;s.size=Math.max(q,0)},set_points_visibility:function(r,q){l(r,q,"points_visible","control_points")},set_polygon_visibility:function(r,q){l(r,q,"polygon_visible","control_polygon")},set_curve_visibility:function(r,q){l(r,q,"curve_visible","curve")},get_dom_element:function(){return h.renderer.domElement}};function m(r){var s=o[r];if(s){var q=s.meshes;f.remove(q.control_points);f.remove(q.control_polygon);f.remove(q.curve)}delete o[r]}function j(t){var s=o[t];var r=null;if(s){r=s.options}else{r=jQuery.extend({},e)}var u=c.get_curve(t);var q=p(u,r.size,g.get_num_points());m(t);o[t]={meshes:q,options:r};f.add(q.control_points);f.add(q.control_polygon);f.add(q.curve);g.set_points_visibility(t,r.points_visible);g.set_polygon_visibility(t,r.polygon_visible);g.set_curve_visibility(t,r.curve_visible);g.update()}c.on(c.EVENT_UPDATED,j);c.on(c.EVENT_ADDED,j);c.on(c.EVENT_CLEARED,m);h.camera_controls.addEventListener("change",b);return g};BEZIER.widgets.render_solid_tube=function(s,e,A){assert(e>0,"radius must be greater than 0.");assert(A>0,"num_points must be greater than 0.");var B=new THREE.MeshLambertMaterial({color:255,emissive:0,ambient:0,shading:THREE.SmoothShading});var q=new THREE.MeshLambertMaterial({color:65280,emissive:0,ambient:0,shading:THREE.SmoothShading});var u=new THREE.MeshLambertMaterial({color:16711680,emissive:0,ambient:0,shading:THREE.SmoothShading});var b=new THREE.Object3D();var f=new THREE.SphereGeometry(e*1.5,16,16);var h,o;for(var z=0;z<s.num_points();z++){h=s.get_point(z);o=new THREE.Mesh(f,B);o.position.x=h.x;o.position.y=h.y;o.position.z=h.z;b.add(o)}var c=new THREE.CurvePath();var k,j,l,a,x;for(z=0;z<s.num_points()-1;z++){k=s.get_point(z);j=s.get_point(z+1);l=new THREE.LineCurve3(new THREE.Vector3(k.x,k.y,k.z),new THREE.Vector3(j.x,j.y,j.z));c.add(l)}var n=new THREE.Mesh(new THREE.TubeGeometry(c,64,e,8,false),q);var y=[];var v;var d=1/A;for(var p=0;p<=1;p+=d){v=s.calculate(p);y.push(new THREE.Vector3(v.x,v.y,v.z))}var w=new THREE.SplineCurve3(y);var m=new THREE.TubeGeometry(w,64,e,8,false);var r=new THREE.Mesh(m,u);var g={};g.control_points=b;g.control_polygon=n;g.curve=r;return g};BEZIER.widgets.stage_basic=function(e,b){var c=13421772;var g=new THREE.WebGLRenderer({antialias:false});g.setClearColor(new THREE.Color(c),1);g.setSize(e,b);var d=new THREE.PerspectiveCamera(60,e/b,1,1000);var a=new THREE.TrackballControls(d,g.domElement);d.position.z=1;a.rotateSpeed=3;a.zoomSpeed=1.2;a.panSpeed=0.8;a.noZoom=false;a.noPan=false;function f(){var i=new THREE.Scene();i.fog=new THREE.FogExp2(c,0.002);var h=new THREE.DirectionalLight(16777215);h.position.set(1,1,1);i.add(h);h=new THREE.DirectionalLight(16777215);h.position.set(-1,-1,-1);i.add(h);h=new THREE.AmbientLight(16777215);i.add(h);return i}return{camera:d,camera_controls:a,make_scene:f,renderer:g}};var BEZIER=BEZIER||{};BEZIER.widgets=BEZIER.widgets||{};BEZIER.widgets.control_point_grid=function(e,d){var b=$("<div></div>");var a=$("<input id='grid_append' type='button' value='Append Row' />");a.click(function(){var f=b.handsontable("countRows");b.handsontable("alter","insert_row",f)});b.append(a);b.handsontable({data:[],minSpareRows:0,contextMenu:["row_above","row_below","remove_row","hsep3","undo","redo"],fillHandle:false,colHeaders:["X","Y","Z"],rowHeaders:true,columns:[{data:"x",type:"numeric",allowInvalid:false},{data:"y",type:"numeric",allowInvalid:false},{data:"z",type:"numeric",allowInvalid:false}],afterRemoveRow:function(f){if(!e.has_curve(d)){return}var g=e.get_curve(d);g.remove_point(f);e.updated(d)},beforeChange:function(f,g){if(!f){return}$(f).each(function(h,i){if(!i[3]&&i[1]!=="highlight"){f[h][3]=0}})},afterChange:function(i,j){if(!i){return}if(!e.has_curve(d)){return}var l=e.get_curve(d);var k,m,h,g;var f;$(i).each(function(n,o){k=o[0];m=o[1];h=o[2];g=o[3];f=l.get_point(k);if(h===g){return}if(m==="x"){f.x=g}else{if(m==="y"){f.y=g}else{if(m==="z"){f.z=g}}}});e.updated(d)},afterCreateRow:function(f){if(!e.has_curve(d)){return}var h=e.get_curve(d);var g=BEZIER.core.dim3(0,0,0);if(f<h.num_points()){h.insert_point(f,g)}else{h.append_point(g)}e.updated(d)}});var c={dom_element:b,curve_name:d,update:function(){if(!e.has_curve(d)){return}var g=[];var j=e.get_curve(d);var h;for(var f=0;f<j.num_points();f++){h=j.get_point(f);g.push({x:h.x,y:h.y,z:h.z})}this.dom_element.handsontable("loadData",g)}};e.on(e.EVENT_UPDATED,function(f){if(c.curve_name!=f){return}c.update()});c.update();return c};BEZIER.widgets.cpg_controller=function(f){var b=$("<div id='tabs'><ul></ul></div>");var e=function(g){return g.replace(/ /g,"_")};var c=function(l,h){var g=e(l);var j=$("<li></li>");var k=$("<a></a>");j.attr("id","link"+g);k.attr("href","#tab"+g);k.html(l);j.append(k);$(b).children("ul").append(j);var i=$("<div></div>");i.attr("id","tab"+g);i.append(h);$(b).append(i);$(b).tabs("refresh");$(k).trigger("click");return i};var a=function(h){var g=e(h);$(b).children("ul").children("li#link"+g).remove();$(b).children("div#tab"+g).remove();$(b).tabs("refresh")};b.tabs();f.on(f.EVENT_ADDED,function(g){var h=BEZIER.widgets.control_point_grid(f,g);c(g,h.dom_element)});f.on(f.EVENT_CLEARED,function(g){a(g)});var d={dom_element:b};return d};var BEZIER=BEZIER||{};BEZIER.parsers=BEZIER.parsers||{};BEZIER.parsers.single=function(b){var a=[];JSON.parse(b).forEach(function(c){a.push(BEZIER.core.dim3(Number(c[0]),Number(c[1]),Number(c[2])))});return BEZIER.core.bezier_curve_3(a)};var BEZIER=BEZIER||{};BEZIER.storage=BEZIER.storage||{};BEZIER.storage.curve_storage=function(){var b={};var a={EVENT_ADDED:"added",EVENT_UPDATED:"changed",EVENT_CLEARED:"cleared",updated:function(c){if(!this.has_curve(c)){return}this.trigger(this.EVENT_UPDATED,c)},get_curve_names:function(){var c=[];for(var d in b){if(b.hasOwnProperty(d)){c.push(d)}}return c},has_curve:function(c){return c in b},get_curve:function(c){if(this.has_curve(c)){return b[c]}return null},get_all_curves:function(){var e=this.get_curve_names();var f={};for(var c=0;c<e.length;c++){var d=e[c];f[d]=this.get_curve(d)}return f},set_curve:function(c,e){var d=this.EVENT_ADDED;if(this.has_curve(c)){d=this.EVENT_UPDATED}b[c]=e;this.trigger(d,c)},clear_curve:function(c){var d=b[c];if(!d){return}delete b[c];this.trigger(this.EVENT_CLEARED,c)},clear_all_curves:function(){var e=this.get_curve_names();for(var c=0;c<e.length;c++){var d=e[c];this.clear_curve(d)}}};_.extend(a,Backbone.Events);return a};var BEZIER=BEZIER||{};BEZIER.errors=BEZIER.errors||{};BEZIER.core=BEZIER.core||{};BEZIER.errors.error=function(a,b){var c=new Error(b);c.name=a;return c};BEZIER.errors.illegal_argument_error=function(a){return BEZIER.errors.error("IllegalArgumentError",a)};function assert(c,a){if(c){return}if(window.console){var b="Assertion Violation: "+(a||"");console.group(b);console.trace();console.groupEnd(b)}throw BEZIER.errors.error("AssertionError",a)}BEZIER.core.dim3=function(a,c,b){return{x:a||0,y:c||0,z:b||0}};BEZIER.core.binomial_coefficients=function(c){assert(c>=0,"n ("+c+") cannot be negative.");var b=[1];for(var a=0;a<c;++a){b[a+1]=(b[a]*(c-a))/(a+1)}return b};BEZIER.core.bezier_calculation=function(d,c){assert(c>=0&&c<=1,"T ("+c+") argument is out of range: 0 <= t <= 1");assert(d.length>0,"No control point given.");var f=d.length-1;var a=0;var e=BEZIER.core.binomial_coefficients(f);for(var b=0;b<d.length;b++){a+=Math.pow(1-c,f-b)*Math.pow(c,b)*d[b]*e[b]}return a};BEZIER.core.bezier_curve_3=function(a){if(a){a=a.slice()}else{a=[]}return{get_point:function(b){return a[b]},append_point:function(b){a.push(b);return a.length-1},insert_point:function(b,c){if(b<0||b>=a.length){throw BEZIER.errors.illegal_argument_error("Index "+b+" is out of range.")}a.splice(b,0,c)},remove_point:function(b){if(b<0||b>=a.length){throw BEZIER.errors.illegal_argument_error("Index "+b+" is out of range.")}a.splice(b,1)},num_points:function(){return a.length},calculate:function(d){var b=[],g=[],f=[];var e=null;if(d<0||d>1){throw BEZIER.errors.illegal_argument_error("T ("+d+") argument is out of range: 0 < t < 1")}if(this.num_points()==0){return null}for(var c=0;c<this.num_points();c++){e=this.get_point(c);b.push(e.x);g.push(e.y);f.push(e.z)}return BEZIER.core.dim3(BEZIER.core.bezier_calculation(b,d),BEZIER.core.bezier_calculation(g,d),BEZIER.core.bezier_calculation(f,d))}}};